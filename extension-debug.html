<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Extension Debug Test</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>🔧 Extension Debug Test</h1>
    
    <div id="status"></div>
    
    <h3>🧪 Test Actions:</h3>
    <button onclick="testPing()">Test Extension Ping</button>
    <button onclick="testAPIConnection()">Test API Connection</button>
    <button onclick="testDatabases()">Test Get Databases</button>
    <button onclick="testContentExtraction()">Test Content Extraction</button>
    <button onclick="checkStorage()">Check Storage</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <h3>📋 Logs:</h3>
    <pre id="logs"></pre>
    
    <h3>💾 Storage:</h3>
    <pre id="storage">Click "Check Storage" to view</pre>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            document.getElementById('logs').textContent = logs.slice(-20).join('\n');
            console.log(logEntry);
        }
        
        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('logs').textContent = '';
        }
        
        async function testPing() {
            try {
                log('🔄 Testing extension ping...');
                setStatus('Testing extension ping...', 'warning');
                
                const response = await chrome.runtime.sendMessage({ action: 'PING' });
                log('✅ Extension ping result: ' + JSON.stringify(response));
                setStatus('Extension ping successful!', 'success');
            } catch (error) {
                log('❌ Extension ping failed: ' + error.message);
                setStatus('Extension ping failed: ' + error.message, 'error');
            }
        }
        
        async function testAPIConnection() {
            try {
                log('🔄 Testing API connection...');
                setStatus('Testing API connection...', 'warning');
                
                const response = await chrome.runtime.sendMessage({ action: 'KIEM_TRA_KET_NOI' });
                log('📡 API connection result: ' + JSON.stringify(response));
                
                if (response.success) {
                    setStatus('API connection successful!', 'success');
                } else {
                    setStatus('API connection failed: ' + (response.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('❌ API connection test failed: ' + error.message);
                setStatus('API connection test failed: ' + error.message, 'error');
            }
        }
        
        async function testDatabases() {
            try {
                log('🔄 Testing get databases...');
                setStatus('Getting databases...', 'warning');
                
                const response = await chrome.runtime.sendMessage({ action: 'LAY_DATABASES' });
                log('📊 Get databases result: ' + JSON.stringify(response));
                
                if (response.success) {
                    const count = response.data ? response.data.length : 0;
                    setStatus(`Found ${count} databases`, count > 0 ? 'success' : 'warning');
                } else {
                    setStatus('Get databases failed: ' + (response.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('❌ Get databases test failed: ' + error.message);
                setStatus('Get databases test failed: ' + error.message, 'error');
            }
        }
        
        async function testContentExtraction() {
            try {
                log('🔄 Testing content extraction...');
                setStatus('Testing content extraction...', 'warning');
                
                const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
                if (tabs[0]) {
                    const response = await chrome.runtime.sendMessage({ 
                        action: 'TRICH_XUAT_DU_LIEU', 
                        tabId: tabs[0].id 
                    });
                    log('📄 Content extraction result: ' + JSON.stringify(response));
                    
                    if (response.success) {
                        setStatus('Content extraction successful!', 'success');
                    } else {
                        setStatus('Content extraction failed: ' + (response.error || 'Unknown error'), 'error');
                    }
                } else {
                    log('❌ No active tab found');
                    setStatus('No active tab found', 'error');
                }
            } catch (error) {
                log('❌ Content extraction test failed: ' + error.message);
                setStatus('Content extraction test failed: ' + error.message, 'error');
            }
        }
        
        async function checkStorage() {
            try {
                log('🔄 Checking storage...');
                const storage = await chrome.storage.local.get();
                document.getElementById('storage').textContent = JSON.stringify(storage, null, 2);
                log('📊 Storage checked, see Storage section below');
                setStatus('Storage data loaded', 'success');
            } catch (error) {
                log('❌ Storage check failed: ' + error.message);
                setStatus('Storage check failed: ' + error.message, 'error');
            }
        }
        
        // Initialize
        log('🚀 Debug test page loaded');
        
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            setStatus('Extension context available', 'success');
            log('✅ Chrome extension API available');
        } else {
            setStatus('Extension context NOT available', 'error');
            log('❌ Chrome extension API not available');
        }
    </script>
</body>
</html>
