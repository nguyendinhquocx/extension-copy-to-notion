<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Extension - Copy to Notion</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .debug-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 8px; }
    .error { background: #ffeaa7; border: 1px solid #fdcb6e; }
    .success { background: #d1f2eb; border: 1px solid #52c786; }
    .warning { background: #fff3cd; border: 1px solid #ffc107; }
    .info { background: #cce7ff; border: 1px solid #007bff; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
    button:hover { background: #0056b3; }
    .console-output { height: 200px; overflow-y: auto; background: #1e1e1e; color: #fff; padding: 10px; font-family: monospace; }
  </style>
</head>
<body>
  <h1>üîß Extension Debug Helper</h1>
  
  <div class="debug-section info">
    <h3>üìä Extension Status</h3>
    <div id="extensionStatus">Checking...</div>
  </div>
  
  <div class="debug-section">
    <h3>üß™ Test Actions</h3>
    <button onclick="testExtensionPing()">Test Extension Ping</button>
    <button onclick="testAPIConnection()">Test API Connection</button>
    <button onclick="testContentExtraction()">Test Content Extraction</button>
    <button onclick="checkStorage()">Check Storage</button>
    <button onclick="clearStorage()">Clear Storage</button>
  </div>
  
  <div class="debug-section">
    <h3>üìã Console Output</h3>
    <div class="console-output" id="consoleOutput"></div>
    <button onclick="clearConsole()">Clear Console</button>
  </div>
  
  <div class="debug-section">
    <h3>üíæ Storage Data</h3>
    <pre id="storageData">Click "Check Storage" to view data</pre>
  </div>
  
  <div class="debug-section">
    <h3>üîç Common Issues & Solutions</h3>
    <details>
      <summary><strong>‚ùå "Could not establish connection. Receiving end does not exist"</strong></summary>
      <ul>
        <li>Service worker ch∆∞a kh·ªüi t·∫°o - Reload extension</li>
        <li>Extension context invalidated - Reload extension</li>
        <li>Background script error - Check extension's service worker console</li>
      </ul>
    </details>
    
    <details>
      <summary><strong>‚ùå "API key is required"</strong></summary>
      <ul>
        <li>API key ch∆∞a ƒë∆∞·ª£c l∆∞u v√†o storage</li>
        <li>Parameter mismatch gi·ªØa popup v√† background</li>
        <li>Storage access permission issue</li>
      </ul>
    </details>
    
    <details>
      <summary><strong>‚ùå Content script injection errors</strong></summary>
      <ul>
        <li>Tab kh√¥ng th·ªÉ inject script (chrome:// pages)</li>
        <li>Content script file path sai</li>
        <li>Permission thi·∫øu trong manifest</li>
      </ul>
    </details>
  </div>

  <script>
    let logBuffer = [];
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      logBuffer.push(logEntry);
      
      const output = document.getElementById('consoleOutput');
      output.innerHTML = logBuffer.slice(-50).join('\n');
      output.scrollTop = output.scrollHeight;
      
      console.log(message);
    }
    
    function clearConsole() {
      logBuffer = [];
      document.getElementById('consoleOutput').innerHTML = '';
    }
    
    async function testExtensionPing() {
      try {
        log('üîÑ Testing extension ping...');
        const response = await chrome.runtime.sendMessage({ action: 'PING' });
        log('‚úÖ Extension ping successful: ' + JSON.stringify(response), 'success');
      } catch (error) {
        log('‚ùå Extension ping failed: ' + error.message, 'error');
      }
    }
    
    async function testAPIConnection() {
      try {
        log('üîÑ Testing API connection...');
        const response = await chrome.runtime.sendMessage({ action: 'KIEM_TRA_KET_NOI' });
        log('üìä API Connection result: ' + JSON.stringify(response), response.success ? 'success' : 'warning');
      } catch (error) {
        log('‚ùå API connection test failed: ' + error.message, 'error');
      }
    }
    
    async function testContentExtraction() {
      try {
        log('üîÑ Testing content extraction...');
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        if (tabs[0]) {
          const response = await chrome.runtime.sendMessage({ 
            action: 'TRICH_XUAT_DU_LIEU', 
            tabId: tabs[0].id 
          });
          log('üìÑ Content extraction result: ' + JSON.stringify(response), response.success ? 'success' : 'error');
        } else {
          log('‚ùå No active tab found', 'error');
        }
      } catch (error) {
        log('‚ùå Content extraction test failed: ' + error.message, 'error');
      }
    }
    
    async function checkStorage() {
      try {
        log('üîÑ Checking storage...');
        const storage = await chrome.storage.local.get();
        document.getElementById('storageData').textContent = JSON.stringify(storage, null, 2);
        log('üìä Storage data loaded in Storage Data section', 'info');
      } catch (error) {
        log('‚ùå Storage check failed: ' + error.message, 'error');
      }
    }
    
    async function clearStorage() {
      try {
        log('üîÑ Clearing storage...');
        await chrome.storage.local.clear();
        await chrome.storage.session.clear();
        document.getElementById('storageData').textContent = 'Storage cleared';
        log('‚úÖ Storage cleared successfully', 'success');
      } catch (error) {
        log('‚ùå Storage clear failed: ' + error.message, 'error');
      }
    }
    
    // Check extension status on load
    async function checkExtensionStatus() {
      const statusDiv = document.getElementById('extensionStatus');
      
      try {
        // Test if extension context is available
        const extensionInfo = await chrome.runtime.sendMessage({ action: 'GET_EXTENSION_INFO' });
        statusDiv.innerHTML = `
          <div class="success">
            ‚úÖ Extension Active<br>
            Version: ${extensionInfo.data.version}<br>
            Name: ${extensionInfo.data.name}
          </div>
        `;
        log('‚úÖ Extension is active and responding');
      } catch (error) {
        statusDiv.innerHTML = `
          <div class="error">
            ‚ùå Extension Error<br>
            ${error.message}
          </div>
        `;
        log('‚ùå Extension status check failed: ' + error.message, 'error');
      }
    }
    
    // Initialize
    if (typeof chrome !== 'undefined' && chrome.runtime) {
      checkExtensionStatus();
      log('üöÄ Debug helper initialized');
    } else {
      log('‚ùå Chrome extension API not available', 'error');
      document.getElementById('extensionStatus').innerHTML = '<div class="error">‚ùå Not running in extension context</div>';
    }
  </script>
</body>
</html>
